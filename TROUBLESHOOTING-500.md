# 🔍 500错误故障排除指南

## 问题原因分析

智谱API返回500内部错误，可能的原因：

1. **API端点不正确** - ✅ 已修复
2. **API密钥格式错误**
3. **API密钥没有访问权限**
4. **智谱AI服务器暂时不可用**
5. **请求参数格式不正确**

## ✅ 已完成的修复

1. ✅ 修改API端点从 `/images/generations` 改为 `/videos/generations`
2. ✅ 增加详细的日志输出
3. ✅ 添加模拟模式（用于演示）

## 🧪 步骤1：测试API连接

运行以下命令测试API连接：

```bash
node test-api.js
```

这将：
- 检查API密钥配置
- 测试API端点连接
- 显示详细的错误信息

## 📋 步骤2：检查API密钥

### 验证API密钥格式

正确的API密钥格式应该是：
```
sk.xxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

或者：
```
sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 检查API密钥权限

1. 登录智谱AI控制台：https://open.bigmodel.cn/
2. 进入 "API Keys" 页面
3. 确认你的API密钥有权限调用CogVideoX-3模型
4. 如果没有权限，需要创建新的API密钥

## 🔧 步骤3：查看详细错误日志

当你尝试生成视频时，请查看命令行窗口的输出：

**正常情况下应该看到：**
```
=====================================
开始生成视频...
=====================================
图片路径: D:\opencode\uploads\xxx.jpg
风格: petals
提示词: A beautiful woman...
=====================================
[INFO] 开始读取图片...
[INFO] 图片大小: 123456 字符
[INFO] 准备请求体...
[INFO] 发送请求到智谱API...
[INFO] 请求模型: cogvideox-3
```

**如果看到500错误，会显示：**
```
[ERROR] 智谱API调用失败:
[ERROR] 状态码: 500
[ERROR] 响应数据: { error: { code: '500', message: '内部错误' } }
```

## 💡 步骤4：尝试模拟模式

如果API暂时不可用，可以使用模拟模式进行演示：

1. 在前端代码中添加模拟参数：
   ```javascript
   const response = await fetch('/api/generate', {
       method: 'POST',
       body: formData
   });
   ```

2. 模拟模式会：
   - 不调用智谱API
   - 模拟5秒的处理时间
   - 返回成功提示（但不生成实际视频）

## 🚨 步骤5：联系智谱AI支持

如果所有步骤都确认无误但仍然500错误，可能是智谱AI服务器的问题：

1. 检查智谱AI官方公告
2. 联系智谱AI技术支持
3. 查看API状态页面

## 📞 获取帮助

### 运行诊断脚本

```bash
node test-api.js
```

### 查看服务器日志

服务器的实时日志会显示在命令行窗口中。

### 收集信息

如果需要技术支持，请准备以下信息：
1. API密钥前7位（如：sk.xxxx）
2. 完整的错误日志
3. 测试API脚本的输出
4. 系统环境（Node.js版本等）

## 🔄 临时解决方案

如果API暂时不可用，你可以：

### 方案A：使用模拟模式
- 演示界面效果
- 测试用户体验
- 准备正式发布

### 方案B：添加错误提示
在前端显示友好的错误信息：
```
视频生成失败，请稍后重试
或联系技术支持
```

### 方案C：切换到其他API
- 考虑使用其他AI视频生成服务
- 如：Runway、Pika等

## ✅ 验证修复

完成上述步骤后：

1. **重新启动服务器**
   ```bash
   # 在新终端运行
   node server.js
   ```

2. **测试API连接**
   ```bash
   # 在另一个终端运行
   node test-api.js
   ```

3. **在浏览器中测试**
   - 打开 http://localhost:3000
   - 上传照片
   - 选择风格
   - 生成视频

## 📊 常见500错误原因

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| 500 | API服务器内部错误 | 稍后重试或联系支持 |
| 401 | API密钥无效 | 检查并更新密钥 |
| 403 | 没有权限访问 | 检查API密钥权限 |
| 404 | API端点不存在 | 检查API URL |
| 429 | 请求过于频繁 | 稍后重试 |

## 🎯 下一步

1. **运行测试脚本**：`node test-api.js`
2. **查看错误日志**：仔细阅读服务器输出
3. **检查API密钥**：确认格式和权限
4. **重新测试**：确认修复后再次尝试

如果问题依然存在，请提供完整的错误日志，我会帮你进一步排查！