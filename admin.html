<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - ä½ ç”»æˆ‘çŒœæ¸¸æˆç»Ÿè®¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .admin-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .admin-title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .admin-subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 1em;
        }

        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            margin: 0 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .page-btn:hover {
            background: #f0f0f0;
        }

        .page-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .date-filter {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-container {
                padding: 10px;
            }
            
            .table-container {
                font-size: 0.8em;
            }
            
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1 class="admin-title">ğŸ“Š æ¸¸æˆç®¡ç†åå°</h1>
            <p class="admin-subtitle">ä½ ç”»æˆ‘çŒœæ¸¸æˆè®¿é—®ç»Ÿè®¡ä¸åˆ†æ</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-number" id="totalVisits">0</div>
                <div class="stat-label">æ€»è®¿é—®é‡</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ®</div>
                <div class="stat-number" id="totalGames">0</div>
                <div class="stat-label">æ¸¸æˆæ¬¡æ•°</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¤</div>
                <div class="stat-number" id="uniqueUsers">0</div>
                <div class="stat-label">ç‹¬ç«‹ç”¨æˆ·</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ“…</div>
                <div class="stat-number" id="todayVisits">0</div>
                <div class="stat-label">ä»Šæ—¥è®¿é—®</div>
            </div>
        </div>

        <div class="content-section">
            <h2 class="section-title">ğŸ“ˆ ä»Šæ—¥ç»Ÿè®¡</h2>
            <div id="todayStats" class="loading">åŠ è½½ä¸­...</div>
        </div>

        <div class="content-section">
            <h2 class="section-title">ğŸ“‹ è®¿é—®æ—¥å¿—</h2>
            
            <div class="date-filter">
                <label>ç­›é€‰æ—¥æœŸï¼š</label>
                <input type="date" id="dateFilter" class="date-input">
                <button class="action-btn btn-primary" onclick="filterLogs()">ç­›é€‰</button>
                <button class="action-btn btn-secondary" onclick="clearFilter()">æ¸…é™¤</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>IPåœ°å€</th>
                            <th>è¡Œä¸º</th>
                            <th>æ•°æ®</th>
                            <th>ç”¨æˆ·ä»£ç†</th>
                        </tr>
                    </thead>
                    <tbody id="logsTable">
                        <tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="pagination">
                <!-- åˆ†é¡µæŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="refreshData()" title="åˆ·æ–°æ•°æ®">
        ğŸ”„
    </button>

    <script>
        class AdminDashboard {
            constructor() {
                this.apiBase = window.location.origin;
                this.currentPage = 1;
                this.pageSize = 20;
                this.totalLogs = 0;
                this.filterDate = null;
                
                this.init();
            }

            async init() {
                await this.loadStats();
                await this.loadTodayStats();
                await this.loadLogs();
                
                // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
                setInterval(() => this.refreshData(), 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
            }

            async loadStats() {
                try {
                    const response = await fetch(`${this.apiBase}/api/stats`);
                    const stats = await response.json();
                    
                    document.getElementById('totalVisits').textContent = stats.totalVisits || 0;
                    document.getElementById('totalGames').textContent = stats.gamesPlayed || 0;
                    document.getElementById('uniqueUsers').textContent = stats.uniqueUsers || 0;
                    
                    // æ›´æ–°ä»Šæ—¥è®¿é—®
                    const today = new Date().toLocaleDateString('zh-CN');
                    const todayData = stats.dailyStats[today];
                    document.getElementById('todayVisits').textContent = todayData ? todayData.visits : 0;
                } catch (error) {
                    console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                }
            }

            async loadTodayStats() {
                try {
                    const response = await fetch(`${this.apiBase}/api/today`);
                    const todayData = await response.json();
                    
                    const statsHtml = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">ğŸ‘ï¸</div>
                                <div class="stat-number">${todayData.visits}</div>
                                <div class="stat-label">ä»Šæ—¥è®¿é—®</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">ğŸ®</div>
                                <div class="stat-number">${todayData.gamesPlayed}</div>
                                <div class="stat-label">ä»Šæ—¥æ¸¸æˆ</div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('todayStats').innerHTML = statsHtml;
                } catch (error) {
                    console.error('åŠ è½½ä»Šæ—¥ç»Ÿè®¡å¤±è´¥:', error);
                    document.getElementById('todayStats').innerHTML = '<p>åŠ è½½å¤±è´¥</p>';
                }
            }

            async loadLogs(page = 1) {
                try {
                    const url = new URL(`${this.apiBase}/api/logs`);
                    url.searchParams.set('limit', this.pageSize);
                    url.searchParams.set('page', page);
                    
                    if (this.filterDate) {
                        url.searchParams.set('date', this.filterDate);
                    }
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    this.totalLogs = data.total;
                    this.currentPage = data.page;
                    this.renderLogs(data.logs);
                    this.renderPagination();
                } catch (error) {
                    console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                    document.getElementById('logsTable').innerHTML = '<tr><td colspan="5">åŠ è½½å¤±è´¥</td></tr>';
                }
            }

            renderLogs(logs) {
                const tbody = document.getElementById('logsTable');
                
                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">æš‚æ— æ•°æ®</td></tr>';
                    return;
                }
                
                const rows = logs.map(log => {
                    const time = new Date(log.timestamp).toLocaleString('zh-CN');
                    const ip = log.ip || 'Unknown';
                    const action = this.getActionBadge(log.action);
                    const data = this.formatData(log.data);
                    const userAgent = this.truncateString(log.userAgent, 30);
                    
                    return `
                        <tr>
                            <td>${time}</td>
                            <td>${ip}</td>
                            <td>${action}</td>
                            <td>${data}</td>
                            <td title="${log.userAgent}">${userAgent}</td>
                        </tr>
                    `;
                }).join('');
                
                tbody.innerHTML = rows;
            }

            getActionBadge(action) {
                const badges = {
                    'visit': '<span class="badge badge-info">è®¿é—®</span>',
                    'game_start': '<span class="badge badge-warning">æ¸¸æˆå¼€å§‹</span>',
                    'game_end': '<span class="badge badge-success">æ¸¸æˆç»“æŸ</span>'
                };
                return badges[action] || `<span class="badge">${action}</span>`;
            }

            formatData(data) {
                if (!data || typeof data !== 'object') return '-';
                
                if (data.word) {
                    return `è¯æ±‡: ${data.word}`;
                }
                if (data.result) {
                    const resultText = data.result === 'ai_won' ? 'AIè·èƒœ' : 'è¶…æ—¶';
                    return `ç»“æœ: ${resultText} (${data.timeSpent?.toFixed(1)}s)`;
                }
                if (data.screen) {
                    return `å±å¹•: ${data.screen}`;
                }
                
                return JSON.stringify(data).substring(0, 50) + '...';
            }

            truncateString(str, maxLength) {
                return str.length > maxLength ? str.substring(0, maxLength) + '...' : str;
            }

            renderPagination() {
                const totalPages = Math.ceil(this.totalLogs / this.pageSize);
                const pagination = document.getElementById('pagination');
                
                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }
                
                let html = '';
                
                // ä¸Šä¸€é¡µ
                if (this.currentPage > 1) {
                    html += `<button class="page-btn" onclick="dashboard.loadLogs(${this.currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
                }
                
                // é¡µç 
                const startPage = Math.max(1, this.currentPage - 2);
                const endPage = Math.min(totalPages, this.currentPage + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    const active = i === this.currentPage ? 'active' : '';
                    html += `<button class="page-btn ${active}" onclick="dashboard.loadLogs(${i})">${i}</button>`;
                }
                
                // ä¸‹ä¸€é¡µ
                if (this.currentPage < totalPages) {
                    html += `<button class="page-btn" onclick="dashboard.loadLogs(${this.currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
                }
                
                pagination.innerHTML = html;
            }

            async refreshData() {
                await Promise.all([
                    this.loadStats(),
                    this.loadTodayStats(),
                    this.loadLogs(this.currentPage)
                ]);
            }

            filterByDate(date) {
                this.filterDate = date;
                this.currentPage = 1;
                this.loadLogs();
            }

            clearFilter() {
                this.filterDate = null;
                document.getElementById('dateFilter').value = '';
                this.currentPage = 1;
                this.loadLogs();
            }
        }

        // å…¨å±€å‡½æ•°
        let dashboard;

        async function refreshData() {
            await dashboard.refreshData();
        }

        function filterLogs() {
            const date = document.getElementById('dateFilter').value;
            dashboard.filterByDate(date);
        }

        function clearFilter() {
            dashboard.clearFilter();
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new AdminDashboard();
        });
    </script>
</body>
</html>