<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ ç”»æˆ‘çŒœ - AIçŒœç”»æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            max-width: 900px;
            width: 100%;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .game-title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            margin-bottom: 20px;
        }

        .canvas-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .canvas-wrapper {
            position: relative;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 10px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }

        #drawingCanvas {
            background: white;
            border-radius: 10px;
            cursor: crosshair;
            display: block;
            width: 100%;
            height: 400px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .control-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        .color-picker {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        .color-picker:hover {
            transform: scale(1.1);
        }

        .brush-size {
            width: 120px;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            cursor: pointer;
        }

        .brush-size::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .brush-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #333;
            transition: all 0.3s;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #ddd;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .timer-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            color: white;
        }

        .timer-label {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .timer-display {
            font-size: 3em;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .timer-display.warning {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .ai-section {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
        }

        .ai-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
        }

        .ai-status {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .ai-guess {
            font-size: 1.2em;
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            margin-top: 10px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .word-display {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            color: white;
        }

        .word-label {
            font-size: 1.1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .current-word {
            font-size: 2em;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .modal-title {
            font-size: 2em;
            color: #333;
            margin-bottom: 20px;
        }

        .modal-result {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: -1;
            }
            
            #drawingCanvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <header class="game-header">
            <h1 class="game-title">ğŸ¨ ä½ ç”»æˆ‘çŒœ</h1>
            <p style="color: #666;">AIçŒœç”»æ¸¸æˆ - ç”»å‡ºä½ çš„åˆ›æ„ï¼</p>
        </header>

        <div class="game-area">
            <div class="canvas-section">
                <div class="canvas-wrapper">
                    <canvas id="drawingCanvas"></canvas>
                </div>
                
                <div class="controls">
                    <div class="control-group">
                        <label class="control-label">ç”»ç¬”é¢œè‰²</label>
                        <input type="color" id="colorPicker" class="color-picker" value="#000000">
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">ç”»ç¬”ç²—ç»†</label>
                        <input type="range" id="brushSize" class="brush-size" min="1" max="20" value="3">
                        <div id="brushPreview" class="brush-preview"></div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="startBtn" class="btn btn-primary">å¼€å§‹æ¸¸æˆ</button>
                    <button id="clearBtn" class="btn btn-secondary">æ¸…ç©ºç”»å¸ƒ</button>
                    <button id="newWordBtn" class="btn btn-secondary">æ¢ä¸€ä¸ªè¯</button>
                </div>
            </div>

            <div class="sidebar">
                <div class="word-display">
                    <div class="word-label">è¦ç”»çš„è¯</div>
                    <div class="current-word" id="currentWord">ç‚¹å‡»å¼€å§‹æ¸¸æˆ</div>
                </div>

                <div class="timer-section">
                    <div class="timer-label">å€’è®¡æ—¶</div>
                    <div class="timer-display" id="timerDisplay">20</div>
                </div>

                <div class="ai-section">
                    <div class="ai-title">ğŸ¤– AI çŒœç”»</div>
                    <div class="ai-status" id="aiStatus">ç­‰å¾…å¼€å§‹...</div>
                    <div class="ai-guess" id="aiGuess"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="game-over-modal" id="gameOverModal">
        <div class="modal-content">
            <h2 class="modal-title">æ¸¸æˆç»“æŸï¼</h2>
            <div class="modal-result" id="modalResult"></div>
            <button id="playAgainBtn" class="btn btn-primary">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // è®¿é—®ç»Ÿè®¡ç±»
        class AccessTracker {
            constructor() {
                this.sessionId = this.generateSessionId();
                this.apiBase = window.location.origin;
                this.trackVisit();
            }

            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            async trackVisit() {
                try {
                    await this.sendLog('visit', {
                        url: window.location.href,
                        referrer: document.referrer,
                        screen: `${screen.width}x${screen.height}`,
                        language: navigator.language
                    });
                } catch (error) {
                    console.log('è®¿é—®ç»Ÿè®¡è®°å½•å¤±è´¥:', error);
                }
            }

            async trackGameStart(word) {
                try {
                    await this.sendLog('game_start', {
                        word: word,
                        timestamp: new Date().toISOString()
                    });
                } catch (error) {
                    console.log('æ¸¸æˆå¼€å§‹ç»Ÿè®¡å¤±è´¥:', error);
                }
            }

            async trackGameEnd(result, timeSpent) {
                try {
                    await this.sendLog('game_end', {
                        result: result,
                        timeSpent: timeSpent,
                        timestamp: new Date().toISOString()
                    });
                } catch (error) {
                    console.log('æ¸¸æˆç»“æŸç»Ÿè®¡å¤±è´¥:', error);
                }
            }

            async sendLog(action, data) {
                const response = await fetch(`${this.apiBase}/api/log`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        data: data,
                        sessionId: this.sessionId
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ç»Ÿè®¡è¯·æ±‚å¤±è´¥');
                }
                
                return response.json();
            }
        }

        class DrawingGame {
            constructor() {
                this.canvas = document.getElementById('drawingCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.isDrawing = false;
                this.isGameActive = false;
                this.timeLeft = 20;
                this.timer = null;
                this.gameStartTime = null;
                this.tracker = new AccessTracker();
                
                this.words = [
                    'å¤ªé˜³', 'æœˆäº®', 'æ˜Ÿæ˜Ÿ', 'è‹¹æœ', 'é¦™è•‰', 'æ±½è½¦', 'é£æœº', 'æˆ¿å­', 'æ ‘æœ¨', 'èŠ±æœµ',
                    'å°çŒ«', 'å°ç‹—', 'é±¼', 'é¸Ÿ', 'è´è¶', 'å±±', 'æ²³æµ', 'äº‘æœµ', 'é›¨ä¼', 'ä¹¦æœ¬',
                    'çœ¼é•œ', 'å¸½å­', 'é‹å­', 'æ‰‹è¡¨', 'æ‰‹æœº', 'ç”µè„‘', 'æ¤…å­', 'æ¡Œå­', 'åºŠ', 'é—¨',
                    'çª—æˆ·', 'è‡ªè¡Œè½¦', 'ç«è½¦', 'èˆ¹', 'æ¡¥', 'é“è·¯', 'çº¢ç»¿ç¯', 'å…¬å›­', 'å­¦æ ¡', 'åŒ»é™¢',
                    'è›‹ç³•', 'å†°æ·‡æ·‹', 'æ±‰å ¡', 'æŠ«è¨', 'å’–å•¡', 'èŒ¶æ¯', 'ç¯®çƒ', 'è¶³çƒ', 'ç½‘çƒ', 'æ¸¸æ³³'
                ];
                
                this.currentWord = '';
                this.setupCanvas();
                this.setupEventListeners();
                this.updateBrushPreview();
            }

            setupCanvas() {
                // è®¾ç½®canvaså®é™…å°ºå¯¸
                const rect = this.canvas.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
                
                // è®¾ç½®é»˜è®¤æ ·å¼
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.strokeStyle = '#000000';
                this.ctx.lineWidth = 3;
            }

            setupEventListeners() {
                // ç”»å¸ƒäº‹ä»¶
                this.canvas.addEventListener('mousedown', this.startDrawing.bind(this));
                this.canvas.addEventListener('mousemove', this.draw.bind(this));
                this.canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
                this.canvas.addEventListener('mouseout', this.stopDrawing.bind(this));
                
                // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
                this.canvas.addEventListener('touchstart', this.handleTouch.bind(this));
                this.canvas.addEventListener('touchmove', this.handleTouch.bind(this));
                this.canvas.addEventListener('touchend', this.stopDrawing.bind(this));
                
                // æ§åˆ¶æŒ‰é’®äº‹ä»¶
                document.getElementById('startBtn').addEventListener('click', this.startGame.bind(this));
                document.getElementById('clearBtn').addEventListener('click', this.clearCanvas.bind(this));
                document.getElementById('newWordBtn').addEventListener('click', this.getNewWord.bind(this));
                document.getElementById('playAgainBtn').addEventListener('click', this.resetGame.bind(this));
                
                // ç”»ç¬”æ§åˆ¶äº‹ä»¶
                document.getElementById('colorPicker').addEventListener('change', this.updateBrushColor.bind(this));
                document.getElementById('brushSize').addEventListener('input', this.updateBrushSize.bind(this));
                
                // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è®¾ç½®canvas
                window.addEventListener('resize', this.setupCanvas.bind(this));
            }

            handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                this.canvas.dispatchEvent(mouseEvent);
            }

            startDrawing(e) {
                if (!this.isGameActive) return;
                
                this.isDrawing = true;
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                this.ctx.beginPath();
                this.ctx.moveTo(x, y);
            }

            draw(e) {
                if (!this.isDrawing || !this.isGameActive) return;
                
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                this.ctx.lineTo(x, y);
                this.ctx.stroke();
            }

            stopDrawing() {
                this.isDrawing = false;
            }

            updateBrushColor(e) {
                this.ctx.strokeStyle = e.target.value;
                this.updateBrushPreview();
            }

            updateBrushSize(e) {
                this.ctx.lineWidth = e.target.value;
                this.updateBrushPreview();
            }

            updateBrushPreview() {
                const preview = document.getElementById('brushPreview');
                const size = document.getElementById('brushSize').value;
                const color = document.getElementById('colorPicker').value;
                
                preview.style.width = Math.min(30, size * 2) + 'px';
                preview.style.height = Math.min(30, size * 2) + 'px';
                preview.style.backgroundColor = color;
            }

            clearCanvas() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }

            getNewWord() {
                const randomIndex = Math.floor(Math.random() * this.words.length);
                this.currentWord = this.words[randomIndex];
                document.getElementById('currentWord').textContent = this.currentWord;
                this.clearCanvas();
            }

            startGame() {
                this.getNewWord();
                this.isGameActive = true;
                this.timeLeft = 20;
                this.gameStartTime = Date.now();
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('aiStatus').textContent = 'AIæ­£åœ¨æ€è€ƒ...';
                document.getElementById('aiGuess').textContent = '';
                
                // è®°å½•æ¸¸æˆå¼€å§‹
                this.tracker.trackGameStart(this.currentWord);
                
                this.startTimer();
                this.simulateAIGuess();
            }

            startTimer() {
                this.updateTimerDisplay();
                
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    this.updateTimerDisplay();
                    
                    if (this.timeLeft <= 5) {
                        document.getElementById('timerDisplay').classList.add('warning');
                    }
                    
                    if (this.timeLeft <= 0) {
                        this.endGame();
                    }
                }, 1000);
            }

            updateTimerDisplay() {
                document.getElementById('timerDisplay').textContent = this.timeLeft;
            }

            simulateAIGuess() {
                // æ¨¡æ‹ŸAIçŒœç”»è¿‡ç¨‹
                const guessTimes = [5, 8, 12, 15, 18];
                const guesses = [
                    'è®©æˆ‘æƒ³æƒ³...',
                    'è¿™æ˜¯æŸç§åŠ¨ç‰©å—ï¼Ÿ',
                    'å¥½åƒæ˜¯æ°´æœï¼Ÿ',
                    'æˆ‘æœ‰ç‚¹å¤´ç»ªäº†ï¼',
                    'æˆ‘çŸ¥é“äº†ï¼'
                ];
                
                guessTimes.forEach((time, index) => {
                    setTimeout(() => {
                        if (this.isGameActive && index < guesses.length - 1) {
                            document.getElementById('aiGuess').textContent = guesses[index];
                        }
                    }, (20 - time) * 1000);
                });
                
                // æœ€ç»ˆçŒœæµ‹
                setTimeout(() => {
                    if (this.isGameActive) {
                        const isCorrect = Math.random() > 0.3; // 70%æ¦‚ç‡çŒœå¯¹
                        if (isCorrect) {
                            document.getElementById('aiGuess').textContent = `ğŸ‰ ${this.currentWord}ï¼`;
                            document.getElementById('aiStatus').textContent = 'AIçŒœå¯¹äº†ï¼';
                            setTimeout(() => this.endGame(true), 1500);
                        } else {
                            const wrongGuess = this.words[Math.floor(Math.random() * this.words.length)];
                            document.getElementById('aiGuess').textContent = `æ˜¯${wrongGuess}å—ï¼Ÿ`;
                            document.getElementById('aiStatus').textContent = 'AIç»§ç»­æ€è€ƒ...';
                        }
                    }
                }, 15000);
            }

            endGame(aiWon = false) {
                this.isGameActive = false;
                clearInterval(this.timer);
                
                const timeSpent = this.gameStartTime ? (Date.now() - this.gameStartTime) / 1000 : 0;
                const result = aiWon ? 'ai_won' : 'timeout';
                
                // è®°å½•æ¸¸æˆç»“æŸ
                this.tracker.trackGameEnd(result, timeSpent);
                
                document.getElementById('timerDisplay').classList.remove('warning');
                document.getElementById('startBtn').disabled = false;
                
                if (aiWon) {
                    document.getElementById('aiStatus').textContent = 'ğŸ‰ AIçŒœå¯¹äº†ï¼';
                    this.showGameOverModal(true);
                } else {
                    document.getElementById('aiStatus').textContent = 'â° æ—¶é—´åˆ°ï¼';
                    document.getElementById('aiGuess').textContent = `ç­”æ¡ˆæ˜¯ï¼š${this.currentWord}`;
                    this.showGameOverModal(false);
                }
            }

            showGameOverModal(aiWon) {
                const modal = document.getElementById('gameOverModal');
                const result = document.getElementById('modalResult');
                
                if (aiWon) {
                    result.innerHTML = `ğŸ‰ å¤ªæ£’äº†ï¼AIæˆåŠŸçŒœå‡ºäº†<br><strong>${this.currentWord}</strong>`;
                } else {
                    result.innerHTML = `â° æ—¶é—´åˆ°äº†ï¼<br>è¦ç”»çš„æ˜¯ <strong>${this.currentWord}</strong>`;
                }
                
                modal.style.display = 'flex';
            }

            resetGame() {
                document.getElementById('gameOverModal').style.display = 'none';
                document.getElementById('currentWord').textContent = 'ç‚¹å‡»å¼€å§‹æ¸¸æˆ';
                document.getElementById('aiStatus').textContent = 'ç­‰å¾…å¼€å§‹...';
                document.getElementById('aiGuess').textContent = '';
                document.getElementById('timerDisplay').textContent = '20';
                this.clearCanvas();
                this.timeLeft = 20;
                this.isGameActive = false;
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', () => {
            new DrawingGame();
        });
    </script>
</body>
</html>